---
# ================================================================================
# PDB Management - Manage Pluggable Databases (Oracle Multitenant)
# ================================================================================
#
# MULTI-INSTANCE SUPPORT:
#   Automatically detects ALL running instances on each host
#
# USAGE:
#   # List all PDBs (all CDBs on host)
#   ansible-playbook playbooks/manage_pdbs.yml --limit crlnxd2201 \
#     -e "action=list"
#
#   # Create new PDB in specific CDB
#   ansible-playbook playbooks/manage_pdbs.yml --limit crlnxd2201 \
#     -e "db_sid=CDB1" \
#     -e "action=create" \
#     -e "pdb_name=APPPDB" \
#     -e "pdb_admin_password=AdminPass123!"
#
#   # Open/Close PDB
#   ansible-playbook playbooks/manage_pdbs.yml --limit crlnxd2201 \
#     -e "db_sid=CDB1" \
#     -e "action=open" \
#     -e "pdb_name=APPPDB"
#
# REPORTS:
#   Saved to: reports/YYYY-MM-DD/hostname/pdbs_<SID>.txt
# ================================================================================

- name: Oracle PDB Management
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    action: "list"  # list, create, clone, open, close, drop
    pdb_name: ""
    pdb_admin_user: "PDBADMIN"
    pdb_admin_password: ""
    source_pdb: "PDB$SEED"
    save_state: true
    report_base_dir: "{{ playbook_dir }}/../reports"
    report_date: "{{ ansible_date_time.date }}"

  tasks:
    # ============================================
    # Auto-detect Oracle Environment
    # ============================================
    - name: Detect Oracle service accounts
      ansible.builtin.shell: |
        grep -E '^svcorat|^svcorap|^oracle' /etc/passwd | head -1 | cut -d: -f1
      register: detected_oracle_user
      changed_when: false
      failed_when: false

    - name: Set Oracle user
      ansible.builtin.set_fact:
        oracle_user: "{{ oracle_user | default(detected_oracle_user.stdout | default('oracle')) }}"

    - name: Detect all running database instances from PMON
      ansible.builtin.shell: |
        ps -ef | grep ora_pmon | grep -v grep | awk -F'_' '{print $NF}' | sort -u
      register: detected_instances
      changed_when: false
      become_user: "{{ oracle_user }}"

    - name: Read oratab entries for ORACLE_HOME mapping
      ansible.builtin.shell: |
        grep -v '^#' /etc/oratab 2>/dev/null | grep ':' || echo ""
      register: oratab_content
      changed_when: false

    - name: Build ORACLE_HOME map from oratab
      ansible.builtin.set_fact:
        oracle_home_map: >-
          {%- set home_map = {} -%}
          {%- for line in oratab_content.stdout_lines -%}
            {%- set parts = line.split(':') -%}
            {%- if parts | length >= 2 -%}
              {%- set _ = home_map.update({parts[0]: parts[1]}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ home_map }}

    - name: Determine instances to process
      ansible.builtin.set_fact:
        instances_to_process: >-
          {%- if db_sid is defined and db_sid != '' -%}
            {{ [db_sid] }}
          {%- else -%}
            {{ detected_instances.stdout_lines | default([]) }}
          {%- endif -%}

    - name: Display detected instances
      ansible.builtin.debug:
        msg: |
          Host: {{ inventory_hostname }}
          Oracle User: {{ oracle_user }}
          Instances: {{ instances_to_process | join(', ') }}
          Action: {{ action }}

    - name: Fail if no instances found
      ansible.builtin.fail:
        msg: "No Oracle instances detected on {{ inventory_hostname }}"
      when: instances_to_process | length == 0

    - name: Create local report directory
      ansible.builtin.file:
        path: "{{ report_base_dir }}/{{ report_date }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: no

    - name: Manage PDBs on each instance
      ansible.builtin.include_tasks: manage_pdbs_instance.yml
      loop: "{{ instances_to_process }}"
      loop_control:
        loop_var: current_sid
