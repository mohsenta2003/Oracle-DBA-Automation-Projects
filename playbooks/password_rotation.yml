---
# ================================================================================
# Password Rotation - Rotate passwords for database users
# ================================================================================
#
# MULTI-INSTANCE SUPPORT:
#   Automatically detects ALL running instances on each host
#   Can target specific instance with db_sid parameter
#
# USAGE:
#   # Rotate password on all instances
#   ansible-playbook playbooks/password_rotation.yml --limit crlnxd2201 \
#     -e "target_user=APP_USER" \
#     -e "new_password=NewSecurePass123!"
#
#   # Rotate on specific instance only
#   ansible-playbook playbooks/password_rotation.yml --limit crlnxd2201 \
#     -e "db_sid=ORCL1" \
#     -e "target_user=APP_USER" \
#     -e "new_password=NewSecurePass123!"
#
#   # Rotate multiple users from file
#   ansible-playbook playbooks/password_rotation.yml --limit crlnxd2201 \
#     -e "@users_passwords.yml"
#
#   users_passwords.yml format:
#     users_to_rotate:
#       - username: APP_USER
#         new_password: NewPass123!
#       - username: BATCH_USER
#         new_password: BatchPass456!
#
# REPORTS:
#   Saved to: reports/YYYY-MM-DD/hostname/password_rotation_<SID>.txt
# ================================================================================

- name: Oracle Password Rotation
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    target_user: ""
    new_password: ""
    users_to_rotate: []
    generate_report: true
    report_base_dir: "{{ playbook_dir }}/../reports"
    report_date: "{{ ansible_date_time.date }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required: Either (target_user + new_password) or users_to_rotate list"
      when: (target_user == '' and users_to_rotate | length == 0)

    # ============================================
    # Auto-detect Oracle Environment
    # ============================================
    - name: Detect Oracle service accounts
      ansible.builtin.shell: |
        grep -E '^svcorat|^svcorap|^oracle' /etc/passwd | head -1 | cut -d: -f1
      register: detected_oracle_user
      changed_when: false
      failed_when: false

    - name: Set Oracle user
      ansible.builtin.set_fact:
        oracle_user: "{{ oracle_user | default(detected_oracle_user.stdout | default('oracle')) }}"

    - name: Detect all running database instances from PMON
      ansible.builtin.shell: |
        ps -ef | grep ora_pmon | grep -v grep | awk -F'_' '{print $NF}' | sort -u
      register: detected_instances
      changed_when: false
      become_user: "{{ oracle_user }}"

    - name: Read oratab entries for ORACLE_HOME mapping
      ansible.builtin.shell: |
        grep -v '^#' /etc/oratab 2>/dev/null | grep ':' || echo ""
      register: oratab_content
      changed_when: false

    - name: Build ORACLE_HOME map from oratab
      ansible.builtin.set_fact:
        oracle_home_map: >-
          {%- set home_map = {} -%}
          {%- for line in oratab_content.stdout_lines -%}
            {%- set parts = line.split(':') -%}
            {%- if parts | length >= 2 -%}
              {%- set _ = home_map.update({parts[0]: parts[1]}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ home_map }}

    - name: Determine instances to process
      ansible.builtin.set_fact:
        instances_to_process: >-
          {%- if db_sid is defined and db_sid != '' -%}
            {{ [db_sid] }}
          {%- else -%}
            {{ detected_instances.stdout_lines | default([]) }}
          {%- endif -%}

    - name: Build rotation list
      ansible.builtin.set_fact:
        rotation_list: >-
          {%- if users_to_rotate | length > 0 -%}
            {{ users_to_rotate }}
          {%- else -%}
            [{"username": "{{ target_user }}", "new_password": "{{ new_password }}"}]
          {%- endif -%}

    - name: Display detected instances
      ansible.builtin.debug:
        msg: |
          Host: {{ inventory_hostname }}
          Oracle User: {{ oracle_user }}
          Detected Instances: {{ detected_instances.stdout_lines | join(', ') }}
          Processing: {{ instances_to_process | join(', ') }}
          Users to rotate: {{ rotation_list | map(attribute='username') | join(', ') }}

    - name: Fail if no instances found
      ansible.builtin.fail:
        msg: "No Oracle instances detected on {{ inventory_hostname }}"
      when: instances_to_process | length == 0

    - name: Create local report directory
      ansible.builtin.file:
        path: "{{ report_base_dir }}/{{ report_date }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: no

    - name: Rotate passwords on each instance
      ansible.builtin.include_tasks: password_rotation_instance.yml
      loop: "{{ instances_to_process }}"
      loop_control:
        loop_var: current_sid
