---
# ================================================================================
# Password Rotation Instance Tasks - Called for each Oracle instance
# ================================================================================

- name: "{{ current_sid }} - Set instance ORACLE_HOME"
  ansible.builtin.set_fact:
    current_oracle_home: "{{ oracle_home_map[current_sid] | default(oracle_home_map.values() | list | first | default('/u01/app/oracle/product/19.0.0/dbhome_1')) }}"

- name: "{{ current_sid }} - Set environment"
  ansible.builtin.set_fact:
    oracle_env:
      ORACLE_HOME: "{{ current_oracle_home }}"
      ORACLE_SID: "{{ current_sid }}"
      LD_LIBRARY_PATH: "{{ current_oracle_home }}/lib"
      PATH: "{{ current_oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin"

- name: "{{ current_sid }} - Set report timestamp"
  ansible.builtin.set_fact:
    report_timestamp: "{{ ansible_date_time.iso8601 }}"

- name: "{{ current_sid }} - Initialize results list"
  ansible.builtin.set_fact:
    rotation_results: []

# ============================================
# Check Users and Rotate Passwords
# ============================================
- name: "{{ current_sid }} - Check user status before rotation"
  ansible.builtin.shell: |
    export ORACLE_HOME="{{ current_oracle_home }}"
    export ORACLE_SID="{{ current_sid }}"
    {{ current_oracle_home }}/bin/sqlplus -s / as sysdba <<EOF
    SET HEADING OFF FEEDBACK OFF PAGESIZE 0 LINESIZE 200
    SELECT username || '|' || account_status || '|' || 
           NVL(TO_CHAR(password_change_date, 'YYYY-MM-DD HH24:MI:SS'), 'NEVER')
    FROM dba_users WHERE username = UPPER('{{ item.username }}');
    EXIT;
    EOF
  loop: "{{ rotation_list }}"
  loop_control:
    label: "{{ item.username }}"
  register: user_status_before
  become_user: "{{ oracle_user }}"
  environment: "{{ oracle_env }}"
  changed_when: false

- name: "{{ current_sid }} - Rotate passwords"
  ansible.builtin.shell: |
    export ORACLE_HOME="{{ current_oracle_home }}"
    export ORACLE_SID="{{ current_sid }}"
    {{ current_oracle_home }}/bin/sqlplus -s / as sysdba <<EOF
    ALTER USER {{ item.username | upper }} IDENTIFIED BY "{{ item.new_password }}";
    EXIT;
    EOF
  loop: "{{ rotation_list }}"
  loop_control:
    label: "{{ item.username }}"
  register: rotate_results
  become_user: "{{ oracle_user }}"
  environment: "{{ oracle_env }}"
  no_log: true
  failed_when: false

- name: "{{ current_sid }} - Check user status after rotation"
  ansible.builtin.shell: |
    export ORACLE_HOME="{{ current_oracle_home }}"
    export ORACLE_SID="{{ current_sid }}"
    {{ current_oracle_home }}/bin/sqlplus -s / as sysdba <<EOF
    SET HEADING OFF FEEDBACK OFF PAGESIZE 0 LINESIZE 200
    SELECT username || '|' || account_status || '|' || 
           NVL(TO_CHAR(password_change_date, 'YYYY-MM-DD HH24:MI:SS'), 'NEVER')
    FROM dba_users WHERE username = UPPER('{{ item.username }}');
    EXIT;
    EOF
  loop: "{{ rotation_list }}"
  loop_control:
    label: "{{ item.username }}"
  register: user_status_after
  become_user: "{{ oracle_user }}"
  environment: "{{ oracle_env }}"
  changed_when: false

# ============================================
# Build Rotation Report
# ============================================
- name: "{{ current_sid }} - Build rotation report"
  ansible.builtin.set_fact:
    rotation_report: |
      ╔═══════════════════════════════════════════════════════════════════════════════════╗
      ║                      PASSWORD ROTATION REPORT                                     ║
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      ║ Execution Time: {{ report_timestamp }}
      ║ Host:           {{ inventory_hostname }}
      ║ Instance:       {{ current_sid }}
      ║ ORACLE_HOME:    {{ current_oracle_home }}
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      ║ USER STATUS BEFORE ROTATION:                                                      ║
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      {% for result in user_status_before.results %}
      ║ {{ result.item.username | upper | ljust(20) }}: {{ result.stdout | default('NOT FOUND') }}
      {% endfor %}
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      ║ ROTATION RESULTS:                                                                 ║
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      {% for result in rotate_results.results %}
      ║ {{ '✅' if result.rc == 0 else '❌' }} {{ result.item.username | upper | ljust(20) }} {{ 'SUCCESS' if result.rc == 0 else 'FAILED' }}
      {% endfor %}
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      ║ USER STATUS AFTER ROTATION:                                                       ║
      ╠═══════════════════════════════════════════════════════════════════════════════════╣
      {% for result in user_status_after.results %}
      ║ {{ result.item.username | upper | ljust(20) }}: {{ result.stdout | default('NOT FOUND') }}
      {% endfor %}
      ╚═══════════════════════════════════════════════════════════════════════════════════╝
      
      ═══════════════════════════════════════════════════════════════════════════════════
      SUMMARY:
      ═══════════════════════════════════════════════════════════════════════════════════
      Total Users:  {{ rotation_list | length }}
      Successful:   {{ rotate_results.results | selectattr('rc', 'equalto', 0) | list | length }}
      Failed:       {{ rotate_results.results | rejectattr('rc', 'equalto', 0) | list | length }}

- name: "{{ current_sid }} - Display rotation report"
  ansible.builtin.debug:
    msg: "{{ rotation_report }}"

- name: "{{ current_sid }} - Save rotation report"
  ansible.builtin.copy:
    content: "{{ rotation_report }}"
    dest: "{{ report_base_dir }}/{{ report_date }}/{{ inventory_hostname }}/password_rotation_{{ current_sid }}.txt"
    mode: '0644'
  delegate_to: localhost
  become: no
