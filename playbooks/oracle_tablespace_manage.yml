---
# ================================================================================
# Oracle Tablespace Management with cx_Oracle Modules
# ================================================================================
#
# This playbook uses the ansible-oracle-modules (cx_Oracle based) for 
# idempotent tablespace management operations.
#
# PREREQUISITES:
#   - cx_Oracle Python library installed
#   - Oracle Instant Client (if running from control machine)
#   - Network connectivity to Oracle listener
#   - System or DBA credentials
#
# USAGE:
#   # Create a normal tablespace
#   ansible-playbook playbooks/oracle_tablespace_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "tablespace_name=APP_DATA" \
#     -e "size=10G" \
#     -e "action=create"
#
#   # Create a bigfile tablespace with autoextend
#   ansible-playbook playbooks/oracle_tablespace_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "tablespace_name=BIGDATA" \
#     -e "size=100G" \
#     -e "bigfile=true" \
#     -e "autoextend=true" \
#     -e "maxsize=500G" \
#     -e "action=create"
#
#   # Create a temporary tablespace
#   ansible-playbook playbooks/oracle_tablespace_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "tablespace_name=APP_TEMP" \
#     -e "content=temp" \
#     -e "size=5G" \
#     -e "action=create"
#
#   # Set tablespace read-only
#   ansible-playbook playbooks/oracle_tablespace_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "tablespace_name=APP_DATA" \
#     -e "action=read_only"
#
#   # Drop a tablespace
#   ansible-playbook playbooks/oracle_tablespace_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "tablespace_name=APP_DATA" \
#     -e "action=drop"
# ================================================================================

- name: Oracle Tablespace Management (cx_Oracle Module)
  hosts: all
  become: no
  gather_facts: no
  
  vars:
    # Connection defaults
    db_hostname: "{{ inventory_hostname }}"
    db_port: 1521
    db_service: "{{ db_sid | default('ORCL') }}"
    db_user: "{{ oracle_dba_user | default('system') }}"
    db_password: "{{ oracle_dba_password | default('') }}"
    db_mode: normal
    # Tablespace defaults
    datafile: "+DATA"  # ASM diskgroup or filesystem path
    size: "100M"
    content: permanent  # permanent, temp, undo
    bigfile: false
    autoextend: true
    nextsize: "100M"
    maxsize: ""  # empty = unlimited
    action: create

  environment:
    ORACLE_HOME: "{{ oracle_home | default('/u01/app/oracle/product/19.0.0/dbhome_1') }}"
    LD_LIBRARY_PATH: "{{ oracle_home | default('/u01/app/oracle/product/19.0.0/dbhome_1') }}/lib"

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable '{{ item }}' is not defined"
      when: vars[item] is not defined or vars[item] == ''
      loop:
        - tablespace_name
        - db_service

    # ============================================
    # Create Tablespace
    # ============================================
    - name: Create Oracle tablespace
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        datafile: "{{ datafile }}"
        size: "{{ size }}"
        content: "{{ content }}"
        bigfile: "{{ bigfile }}"
        autoextend: "{{ autoextend }}"
        next: "{{ nextsize }}"
        maxsize: "{{ maxsize }}"
        state: present
      when: action == 'create'
      register: create_result

    - name: Display create result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} created successfully ({{ size }}, bigfile={{ bigfile }}, autoextend={{ autoextend }})"
      when: 
        - action == 'create'
        - create_result.changed | default(false)

    # ============================================
    # Set Read-Only
    # ============================================
    - name: Set tablespace read-only
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        state: read_only
      when: action == 'read_only'
      register: readonly_result

    - name: Display read-only result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} set to READ ONLY"
      when: 
        - action == 'read_only'
        - readonly_result.changed | default(false)

    # ============================================
    # Set Read-Write
    # ============================================
    - name: Set tablespace read-write
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        state: read_write
      when: action == 'read_write'
      register: readwrite_result

    - name: Display read-write result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} set to READ WRITE"
      when: 
        - action == 'read_write'
        - readwrite_result.changed | default(false)

    # ============================================
    # Set Offline
    # ============================================
    - name: Set tablespace offline
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        state: offline
      when: action == 'offline'
      register: offline_result

    - name: Display offline result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} set to OFFLINE"
      when: 
        - action == 'offline'
        - offline_result.changed | default(false)

    # ============================================
    # Set Online
    # ============================================
    - name: Set tablespace online
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        state: online
      when: action == 'online'
      register: online_result

    - name: Display online result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} set to ONLINE"
      when: 
        - action == 'online'
        - online_result.changed | default(false)

    # ============================================
    # Drop Tablespace
    # ============================================
    - name: Drop Oracle tablespace
      oracle_tablespace:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        tablespace: "{{ tablespace_name }}"
        state: absent
      when: action == 'drop'
      register: drop_result

    - name: Display drop result
      ansible.builtin.debug:
        msg: "Tablespace {{ tablespace_name }} dropped successfully"
      when: 
        - action == 'drop'
        - drop_result.changed | default(false)
