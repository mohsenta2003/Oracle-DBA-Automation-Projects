---
# ================================================================================
# Oracle Grants Management with cx_Oracle Modules
# ================================================================================
#
# This playbook uses the ansible-oracle-modules (cx_Oracle based) for 
# idempotent privilege management.
#
# PREREQUISITES:
#   - cx_Oracle Python library installed
#   - Network connectivity to Oracle listener
#   - System or DBA credentials
#
# USAGE:
#   # Grant privileges to a user
#   ansible-playbook playbooks/oracle_grants_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "schema_name=APP_USER" \
#     -e "grants=['CONNECT','RESOURCE','CREATE VIEW','SELECT ANY TABLE']" \
#     -e "action=grant"
#
#   # Revoke specific privileges
#   ansible-playbook playbooks/oracle_grants_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "schema_name=APP_USER" \
#     -e "grants=['SELECT ANY TABLE']" \
#     -e "action=revoke"
#
#   # Enforce exact grant list (removes extra grants)
#   ansible-playbook playbooks/oracle_grants_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "schema_name=APP_USER" \
#     -e "grants=['CONNECT','RESOURCE']" \
#     -e "grants_mode=enforce" \
#     -e "action=grant"
#
#   # Grant object privileges
#   ansible-playbook playbooks/oracle_grants_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "schema_name=APP_USER" \
#     -e "object_privs=['SELECT,INSERT,UPDATE:HR.EMPLOYEES','SELECT:HR.DEPARTMENTS']" \
#     -e "action=grant_objects"
#
#   # Remove ALL privileges from a user
#   ansible-playbook playbooks/oracle_grants_manage.yml --limit crlnxd2201 \
#     -e "db_service=ORCL" \
#     -e "schema_name=APP_USER" \
#     -e "action=revoke_all"
# ================================================================================

- name: Oracle Grants Management (cx_Oracle Module)
  hosts: all
  become: no
  gather_facts: no
  
  vars:
    # Connection defaults
    db_hostname: "{{ inventory_hostname }}"
    db_port: 1521
    db_service: "{{ db_sid | default('ORCL') }}"
    db_user: "{{ oracle_dba_user | default('system') }}"
    db_password: "{{ oracle_dba_password | default('') }}"
    db_mode: normal
    # Grant defaults
    grants: []
    object_privs: []
    grants_mode: append  # append or enforce
    action: grant

  environment:
    ORACLE_HOME: "{{ oracle_home | default('/u01/app/oracle/product/19.0.0/dbhome_1') }}"
    LD_LIBRARY_PATH: "{{ oracle_home | default('/u01/app/oracle/product/19.0.0/dbhome_1') }}/lib"

  tasks:
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable '{{ item }}' is not defined"
      when: vars[item] is not defined or vars[item] == ''
      loop:
        - schema_name
        - db_service

    # ============================================
    # Grant System/Role Privileges
    # ============================================
    - name: Grant privileges to user
      oracle_grants:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        schema: "{{ schema_name }}"
        grants: "{{ grants }}"
        grants_mode: "{{ grants_mode }}"
        state: present
      when: 
        - action == 'grant'
        - grants | length > 0
      register: grant_result

    - name: Display grant result
      ansible.builtin.debug:
        msg: "Granted {{ grants | join(', ') }} to {{ schema_name }}"
      when: 
        - action == 'grant'
        - grant_result.changed | default(false)

    # ============================================
    # Grant Object Privileges
    # ============================================
    - name: Grant object privileges
      oracle_grants:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        schema: "{{ schema_name }}"
        object_privs: "{{ object_privs }}"
        state: present
      when: 
        - action == 'grant_objects'
        - object_privs | length > 0
      register: obj_grant_result

    - name: Display object grant result
      ansible.builtin.debug:
        msg: "Granted object privileges to {{ schema_name }}"
      when: 
        - action == 'grant_objects'
        - obj_grant_result.changed | default(false)

    # ============================================
    # Revoke Specific Privileges
    # ============================================
    - name: Revoke privileges from user
      oracle_grants:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        schema: "{{ schema_name }}"
        grants: "{{ grants }}"
        state: absent
      when: 
        - action == 'revoke'
        - grants | length > 0
      register: revoke_result

    - name: Display revoke result
      ansible.builtin.debug:
        msg: "Revoked {{ grants | join(', ') }} from {{ schema_name }}"
      when: 
        - action == 'revoke'
        - revoke_result.changed | default(false)

    # ============================================
    # Revoke ALL Privileges
    # ============================================
    - name: Revoke ALL privileges from user
      oracle_grants:
        hostname: "{{ db_hostname }}"
        port: "{{ db_port }}"
        service_name: "{{ db_service }}"
        user: "{{ db_user }}"
        password: "{{ db_password }}"
        mode: "{{ db_mode }}"
        schema: "{{ schema_name }}"
        state: REMOVEALL
      when: action == 'revoke_all'
      register: revoke_all_result

    - name: Display revoke all result
      ansible.builtin.debug:
        msg: "Removed ALL privileges from {{ schema_name }}"
      when: 
        - action == 'revoke_all'
        - revoke_all_result.changed | default(false)
