---
# ================================================================================
# Clone Schema Playbook - Clone schema using Data Pump within/between instances
# ================================================================================
# Uses Data Pump Export/Import for schema cloning operations
#
# Usage:
#   ansible-playbook playbooks/clone_schema.yml --limit oracle_servers \
#     -e "source_schema=HR target_schema=HR_CLONE action=clone"
#
# Actions:
#   - clone:     Clone schema within same instance (export then import as new name)
#   - export:    Export schema to dump file only
#   - import:    Import schema from dump file
#   - estimate:  Estimate export size without creating dump
#   - list:      List existing Data Pump dump files
#   - status:    Show Data Pump job status
#
# Required Variables:
#   - source_schema: Source schema to clone/export
#   - target_schema: Target schema name (for clone action)
#   - db_sid: (optional) Target specific instance
#
# Example Commands:
#   Clone schema:
#     ansible-playbook playbooks/clone_schema.yml -e "source_schema=HR target_schema=HR_DEV"
#   Export only:
#     ansible-playbook playbooks/clone_schema.yml -e "action=export source_schema=HR"
#   Estimate size:
#     ansible-playbook playbooks/clone_schema.yml -e "action=estimate source_schema=HR"
# ================================================================================

- name: Clone Oracle Schema using Data Pump
  hosts: all
  gather_facts: yes
  become: yes
  
  vars:
    # Action to perform
    action: clone
    
    # Schema details
    source_schema: ""
    target_schema: ""
    
    # Data Pump directory (must exist in database)
    datapump_dir: DATA_PUMP_DIR
    
    # Dump file naming
    dump_prefix: "expdp"
    include_timestamp: true
    
    # Export options
    parallel: 4
    compression: ALL
    content: ALL  # ALL, DATA_ONLY, METADATA_ONLY
    exclude_stats: false
    
    # Import options
    table_exists_action: SKIP  # SKIP, APPEND, REPLACE, TRUNCATE
    remap_tablespace: ""       # "source_ts:target_ts"
    transform_segment_attrs: true
    
    # Report directory
    report_base_dir: "{{ playbook_dir }}/../reports"
    report_date: "{{ ansible_date_time.date }}"
    
    # Target specific SID (optional)
    db_sid: ""

  pre_tasks:
    - name: Validate required variables for clone
      ansible.builtin.fail:
        msg: "Both source_schema and target_schema are required for clone action"
      when: action == 'clone' and (source_schema == '' or target_schema == '')

    - name: Validate required variables for export
      ansible.builtin.fail:
        msg: "source_schema is required for export/estimate actions"
      when: action in ['export', 'estimate'] and source_schema == ''

  tasks:
    # ==========================================
    # Detect Oracle user from OS
    # ==========================================
    - name: Detect Oracle service accounts from OS
      ansible.builtin.shell: |
        grep -E '^svcorat|^svcorap|^oracle' /etc/passwd | head -1 | cut -d: -f1
      register: detected_oracle_user
      changed_when: false
      failed_when: detected_oracle_user.stdout == ""

    - name: Set Oracle user
      ansible.builtin.set_fact:
        oracle_user: "{{ detected_oracle_user.stdout }}"

    # ==========================================
    # Detect all running database instances
    # ==========================================
    - name: Detect all running database instances from PMON
      ansible.builtin.shell: |
        ps -ef | grep ora_pmon | grep -v grep | awk -F'_' '{print $NF}' | sort -u
      register: running_instances
      changed_when: false

    - name: Fail if no instances found
      ansible.builtin.fail:
        msg: "No running Oracle instances found on this host"
      when: running_instances.stdout_lines | length == 0

    - name: Display detected instances
      ansible.builtin.debug:
        msg: "Detected instances: {{ running_instances.stdout_lines | join(', ') }}"

    # ==========================================
    # Get ORACLE_HOME for each instance
    # ==========================================
    - name: Read oratab entries
      ansible.builtin.shell: |
        grep -v '^#' /etc/oratab 2>/dev/null | grep ':' || echo ""
      register: oratab_content
      changed_when: false

    - name: Build ORACLE_HOME map from oratab
      ansible.builtin.set_fact:
        oracle_home_map: >-
          {{
            oracle_home_map | default({}) | combine({
              item.split(':')[0]: item.split(':')[1]
            })
          }}
      loop: "{{ oratab_content.stdout_lines }}"
      when: item != '' and ':' in item

    - name: Display ORACLE_HOME mappings
      ansible.builtin.debug:
        msg: "ORACLE_HOME map: {{ oracle_home_map | default({}) }}"

    # ==========================================
    # Create report directory
    # ==========================================
    - name: Create report directory on control machine
      ansible.builtin.file:
        path: "{{ report_base_dir }}/{{ report_date }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: no
      run_once: false

    # ==========================================
    # Determine which instances to process
    # ==========================================
    - name: Set instances to process
      ansible.builtin.set_fact:
        instances_to_process: "{{ [db_sid] if db_sid != '' and db_sid in running_instances.stdout_lines else running_instances.stdout_lines }}"

    - name: Display instances to be processed
      ansible.builtin.debug:
        msg: "Will process instances: {{ instances_to_process | join(', ') }}"

    # ==========================================
    # Process each instance
    # ==========================================
    - name: Process each Oracle instance for schema clone
      ansible.builtin.include_tasks: clone_schema_instance.yml
      loop: "{{ instances_to_process }}"
      loop_control:
        loop_var: current_sid

    # ==========================================
    # Summary
    # ==========================================
    - name: Schema Clone Summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════
          SCHEMA CLONE OPERATION COMPLETE
          ═══════════════════════════════════════════════════
          Host:           {{ inventory_hostname }}
          Action:         {{ action }}
          Source Schema:  {{ source_schema }}
          Target Schema:  {{ target_schema if action == 'clone' else 'N/A' }}
          Instances:      {{ instances_to_process | join(', ') }}
          Reports:        {{ report_base_dir }}/{{ report_date }}/{{ inventory_hostname }}/
          ═══════════════════════════════════════════════════
