---
# Backup scheduling for a single instance
# Called from main.yml with loop_var: current_sid
#
# Optional variables:
#   -e "backup_type=full|incremental|archivelog" (default: full)
#   -e "schedule_hour=22" (default: 22)
#   -e "schedule_minute=0" (default: 0)
#   -e "schedule_day=*" (default: * = daily)
#   -e "retention_days=7" (default: 7)
#   -e "backup_dest=/backup"
#   -e "apply_schedule=true" (default: false = dry-run)
#

  - name: "{{ current_sid }} - Get ORACLE_HOME"
    ansible.builtin.set_fact:
      _current_oracle_home: "{{ _oratab_map[current_sid] | default(_oratab_map.values() | first) }}"

  - name: "{{ current_sid }} - Get ORACLE_BASE"
    ansible.builtin.shell:
      cmd: |
        echo "{{ _current_oracle_home }}" | sed 's|/product/.*||'
    become: no
    register: current_oracle_base
    changed_when: false

  - name: "{{ current_sid }} - Set Oracle facts"
    ansible.builtin.set_fact:
      _current_oracle_base: "{{ current_oracle_base.stdout | trim }}"
      _backup_type: "{{ backup_type | default('full') }}"
      _schedule_hour: "{{ schedule_hour | default('22') }}"
      _schedule_minute: "{{ schedule_minute | default('0') }}"
      _schedule_day: "{{ schedule_day | default('*') }}"
      _retention_days: "{{ retention_days | default('7') }}"
      _backup_dest: "{{ backup_dest | default(_current_oracle_base + '/backup/' + current_sid) }}"

  - name: "{{ current_sid }} - Display instance info"
    ansible.builtin.debug:
      msg: "Scheduling backup for: {{ current_sid }} | ORACLE_HOME: {{ _current_oracle_home }}"

  # ============================================
  # Check existing cron jobs
  # ============================================
  - name: "{{ current_sid }} - Check existing cron jobs"
    ansible.builtin.shell:
      cmd: "crontab -l 2>/dev/null | grep -i '{{ current_sid }}' || echo 'No existing backup jobs for {{ current_sid }}'"
    become: yes
    become_user: "{{ _oracle_user }}"
    register: existing_cron
    failed_when: false
    changed_when: false

  # ============================================
  # Generate backup script
  # ============================================
  - name: "{{ current_sid }} - Set backup script content"
    ansible.builtin.set_fact:
      _backup_script: |
        #!/bin/bash
        #
        # RMAN Backup Script for {{ current_sid }}
        # Generated by Ansible on {{ ansible_date_time.iso8601 }}
        # Type: {{ _backup_type }}
        #
        
        # Oracle Environment
        export ORACLE_SID={{ current_sid }}
        export ORACLE_HOME={{ _current_oracle_home }}
        export ORACLE_BASE={{ _current_oracle_base }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export NLS_DATE_FORMAT='YYYY-MM-DD HH24:MI:SS'
        
        # Backup Configuration
        BACKUP_DEST="{{ _backup_dest }}"
        RETENTION_DAYS={{ _retention_days }}
        LOG_FILE="$BACKUP_DEST/logs/rman_{{ _backup_type }}_$(date +%Y%m%d_%H%M%S).log"
        
        # Create directories
        mkdir -p "$BACKUP_DEST/full" "$BACKUP_DEST/incremental" "$BACKUP_DEST/archivelog" "$BACKUP_DEST/logs"
        
        echo "=====================================" >> $LOG_FILE
        echo "RMAN Backup Started: $(date)" >> $LOG_FILE
        echo "Database: {{ current_sid }}" >> $LOG_FILE
        echo "Type: {{ _backup_type }}" >> $LOG_FILE
        echo "=====================================" >> $LOG_FILE
        
        {% if _backup_type == 'full' %}
        # Full Database Backup
        rman target / << EOF >> $LOG_FILE 2>&1
        RUN {
            ALLOCATE CHANNEL ch1 DEVICE TYPE DISK;
            ALLOCATE CHANNEL ch2 DEVICE TYPE DISK;
            
            BACKUP AS COMPRESSED BACKUPSET DATABASE
            FORMAT '$BACKUP_DEST/full/full_%d_%T_%s_%p.bkp'
            TAG 'FULL_{{ current_sid }}_$(date +%Y%m%d)';
            
            BACKUP CURRENT CONTROLFILE
            FORMAT '$BACKUP_DEST/full/ctrl_%d_%T_%s_%p.bkp';
            
            BACKUP SPFILE
            FORMAT '$BACKUP_DEST/full/spfile_%d_%T_%s_%p.bkp';
            
            SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';
            
            BACKUP ARCHIVELOG ALL
            FORMAT '$BACKUP_DEST/archivelog/arch_%d_%T_%s_%p.bkp'
            DELETE INPUT;
            
            CROSSCHECK BACKUP;
            DELETE NOPROMPT OBSOLETE RECOVERY WINDOW OF $RETENTION_DAYS DAYS;
            
            RELEASE CHANNEL ch1;
            RELEASE CHANNEL ch2;
        }
        EXIT;
        EOF
        {% elif _backup_type == 'incremental' %}
        # Incremental Backup (Level 1)
        rman target / << EOF >> $LOG_FILE 2>&1
        RUN {
            ALLOCATE CHANNEL ch1 DEVICE TYPE DISK;
            
            BACKUP AS COMPRESSED BACKUPSET
            INCREMENTAL LEVEL 1 DATABASE
            FORMAT '$BACKUP_DEST/incremental/incr_%d_%T_%s_%p.bkp'
            TAG 'INCR_{{ current_sid }}_$(date +%Y%m%d)';
            
            SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';
            
            BACKUP ARCHIVELOG ALL
            FORMAT '$BACKUP_DEST/archivelog/arch_%d_%T_%s_%p.bkp'
            DELETE INPUT;
            
            CROSSCHECK BACKUP;
            DELETE NOPROMPT OBSOLETE RECOVERY WINDOW OF $RETENTION_DAYS DAYS;
            
            RELEASE CHANNEL ch1;
        }
        EXIT;
        EOF
        {% else %}
        # Archivelog Only Backup
        rman target / << EOF >> $LOG_FILE 2>&1
        RUN {
            ALLOCATE CHANNEL ch1 DEVICE TYPE DISK;
            
            SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';
            
            BACKUP ARCHIVELOG ALL
            FORMAT '$BACKUP_DEST/archivelog/arch_%d_%T_%s_%p.bkp'
            TAG 'ARCH_{{ current_sid }}_$(date +%Y%m%d)';
            
            CROSSCHECK BACKUP;
            DELETE NOPROMPT ARCHIVELOG ALL BACKED UP 2 TIMES TO DISK;
            
            RELEASE CHANNEL ch1;
        }
        EXIT;
        EOF
        {% endif %}
        
        # Capture exit status
        RMAN_STATUS=$?
        
        echo "=====================================" >> $LOG_FILE
        echo "RMAN Backup Completed: $(date)" >> $LOG_FILE
        echo "Exit Status: $RMAN_STATUS" >> $LOG_FILE
        echo "=====================================" >> $LOG_FILE
        
        # Cleanup old logs
        find $BACKUP_DEST/logs -name "*.log" -mtime +$RETENTION_DAYS -delete 2>/dev/null
        
        exit $RMAN_STATUS

  # ============================================
  # Generate cron entry
  # ============================================
  - name: "{{ current_sid }} - Set cron entry"
    ansible.builtin.set_fact:
      _cron_entry: "{{ _schedule_minute }} {{ _schedule_hour }} {{ _schedule_day }} * * {{ _current_oracle_base }}/scripts/rman_backup_{{ current_sid }}.sh >> {{ _current_oracle_base }}/backup/{{ current_sid }}/logs/cron_$(date +\\%Y\\%m\\%d).log 2>&1"

  # ============================================
  # Apply schedule (if enabled)
  # ============================================
  - name: "{{ current_sid }} - Create scripts directory"
    ansible.builtin.file:
      path: "{{ _current_oracle_base }}/scripts"
      state: directory
      owner: "{{ _oracle_user }}"
      group: "{{ _oracle_group }}"
      mode: '0755'
    become: yes
    when: apply_schedule | default(false) | bool

  - name: "{{ current_sid }} - Create backup script"
    ansible.builtin.copy:
      content: "{{ _backup_script }}"
      dest: "{{ _current_oracle_base }}/scripts/rman_backup_{{ current_sid }}.sh"
      owner: "{{ _oracle_user }}"
      group: "{{ _oracle_group }}"
      mode: '0755'
    become: yes
    when: apply_schedule | default(false) | bool

  - name: "{{ current_sid }} - Create cron job"
    ansible.builtin.cron:
      name: "RMAN {{ _backup_type }} backup for {{ current_sid }}"
      minute: "{{ _schedule_minute }}"
      hour: "{{ _schedule_hour }}"
      day: "{{ _schedule_day }}"
      job: "{{ _current_oracle_base }}/scripts/rman_backup_{{ current_sid }}.sh >> {{ _current_oracle_base }}/backup/{{ current_sid }}/logs/cron_$(date +\\%Y\\%m\\%d).log 2>&1"
      user: "{{ _oracle_user }}"
    become: yes
    when: apply_schedule | default(false) | bool

  # ============================================
  # Save Schedule Report
  # ============================================
  - name: "{{ current_sid }} - Save schedule report"
    ansible.builtin.copy:
      content: |
        ================================================================================
                         ORACLE BACKUP SCHEDULE REPORT
        ================================================================================
        Host:        {{ inventory_hostname }}
        Database:    {{ current_sid }}
        Oracle User: {{ _oracle_user }}
        ORACLE_HOME: {{ _current_oracle_home }}
        ORACLE_BASE: {{ _current_oracle_base }}
        Generated:   {{ ansible_date_time.iso8601 }}
        Mode:        {{ 'APPLIED' if (apply_schedule | default(false) | bool) else 'DRY-RUN (not applied)' }}
        ================================================================================
        
        
        ================================================================================
        SCHEDULE CONFIGURATION
        ================================================================================
        Backup Type:     {{ _backup_type }}
        Schedule:        {{ _schedule_minute }} {{ _schedule_hour }} {{ _schedule_day }} * *
                         ({{ 'Daily' if _schedule_day == '*' else 'Day ' + _schedule_day }} at {{ _schedule_hour }}:{{ _schedule_minute }})
        Retention:       {{ _retention_days }} days
        Backup Dest:     {{ _backup_dest }}
        Script Location: {{ _current_oracle_base }}/scripts/rman_backup_{{ current_sid }}.sh
        
        
        ================================================================================
        EXISTING CRON JOBS FOR {{ current_sid }}
        ================================================================================
        {{ existing_cron.stdout | default('Unable to check cron') }}
        
        
        ================================================================================
        NEW CRON ENTRY
        ================================================================================
        # RMAN {{ _backup_type }} backup for {{ current_sid }}
        {{ _cron_entry }}
        
        
        ================================================================================
        BACKUP SCRIPT CONTENT
        ================================================================================
        {{ _backup_script }}
        
        
        ================================================================================
        MANUAL COMMANDS
        ================================================================================
        
        To manually run the backup:
          su - {{ _oracle_user }}
          {{ _current_oracle_base }}/scripts/rman_backup_{{ current_sid }}.sh
        
        To view cron jobs:
          su - {{ _oracle_user }}
          crontab -l
        
        To edit cron jobs:
          su - {{ _oracle_user }}
          crontab -e
        
        To check backup status:
          export ORACLE_SID={{ current_sid }}
          export ORACLE_HOME={{ _current_oracle_home }}
          rman target / << EOF
          LIST BACKUP SUMMARY;
          REPORT NEED BACKUP DAYS 7;
          EXIT;
          EOF
        
        ================================================================================
                                    END OF REPORT
        ================================================================================
      dest: "{{ _local_report_dir }}/schedule_{{ current_sid }}.txt"
    delegate_to: localhost
    become: no

  - name: "{{ current_sid }} - Display schedule summary"
    ansible.builtin.debug:
      msg: |
        
        -------- {{ current_sid }} BACKUP SCHEDULE --------
        Type: {{ _backup_type }}
        Schedule: {{ _schedule_hour }}:{{ _schedule_minute }} {{ 'Daily' if _schedule_day == '*' else 'Day ' + _schedule_day }}
        Mode: {{ 'APPLIED' if (apply_schedule | default(false) | bool) else 'DRY-RUN (use -e apply_schedule=true to apply)' }}
        ðŸ“„ Report: schedule_{{ current_sid }}.txt
