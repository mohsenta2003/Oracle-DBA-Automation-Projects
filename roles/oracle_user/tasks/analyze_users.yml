---
# Analyze users for a single instance
# Called from main.yml with loop_var: current_sid

  - name: "{{ current_sid }} - Get ORACLE_HOME"
    ansible.builtin.set_fact:
      _current_oracle_home: "{{ _oratab_map[current_sid] | default(_oratab_map.values() | first) }}"

  - name: "{{ current_sid }} - Display instance info"
    ansible.builtin.debug:
      msg: "Analyzing users for: {{ current_sid }} | ORACLE_HOME: {{ _current_oracle_home }}"

  # ============================================
  # List database users (CSV format)
  # ============================================
  - name: "{{ current_sid }} - List database users"
    ansible.builtin.shell:
      cmd: |
        export ORACLE_HOME={{ _current_oracle_home }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export ORACLE_SID={{ current_sid }}
        sqlplus -s / as sysdba << 'EOSQL'
        SET LINESIZE 500
        SET PAGESIZE 0
        SET HEADING OFF
        SET FEEDBACK OFF
        SET TRIMSPOOL ON
        SELECT 
          username || ',' ||
          account_status || ',' ||
          default_tablespace || ',' ||
          profile || ',' ||
          TO_CHAR(created, 'YYYY-MM-DD') || ',' ||
          TO_CHAR(expiry_date, 'YYYY-MM-DD') || ',' ||
          TO_CHAR(lock_date, 'YYYY-MM-DD')
        FROM dba_users 
        WHERE oracle_maintained = 'N' 
        ORDER BY account_status, username;
        EXIT;
        EOSQL
    become: yes
    become_user: "{{ _oracle_user }}"
    register: db_users
    failed_when: false

  # ============================================
  # Save user report locally (CSV format)
  # ============================================
  - name: "{{ current_sid }} - Save user report"
    ansible.builtin.copy:
      content: |
        ================================================================================
        ORACLE DATABASE USERS REPORT
        ================================================================================
        Host:        {{ inventory_hostname }}
        Database:    {{ current_sid }}
        Oracle User: {{ _oracle_user }}
        ORACLE_HOME: {{ _current_oracle_home }}
        Generated:   {{ ansible_date_time.iso8601 }}
        ================================================================================
        
        USERNAME,ACCOUNT_STATUS,DEFAULT_TABLESPACE,PROFILE,CREATED,EXPIRY_DATE,LOCK_DATE
        {{ db_users.stdout | trim }}
      dest: "{{ _local_report_dir }}/users_{{ current_sid }}.csv"
    delegate_to: localhost
    become: no

  # ============================================
  # Display summary by status
  # ============================================
  - name: "{{ current_sid }} - Count users by status"
    ansible.builtin.shell:
      cmd: |
        export ORACLE_HOME={{ _current_oracle_home }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export ORACLE_SID={{ current_sid }}
        sqlplus -s / as sysdba << 'EOSQL'
        SET LINESIZE 200
        SET PAGESIZE 100
        SET HEADING ON
        SET FEEDBACK OFF
        SELECT account_status, COUNT(*) as user_count 
        FROM dba_users 
        WHERE oracle_maintained = 'N' 
        GROUP BY account_status 
        ORDER BY user_count DESC;
        EXIT;
        EOSQL
    become: yes
    become_user: "{{ _oracle_user }}"
    register: user_summary
    failed_when: false

  - name: "{{ current_sid }} - Display user summary"
    ansible.builtin.debug:
      msg: |
        
        ========== USER STATUS ({{ current_sid }}) ==========
        {{ user_summary.stdout }}
        =====================================================

  # ============================================
  # Check if specific user exists (optional)
  # Usage: -e "check_user=USERNAME"
  # ============================================
  - name: "{{ current_sid }} - Check if user exists"
    ansible.builtin.shell:
      cmd: |
        export ORACLE_HOME={{ _current_oracle_home }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export ORACLE_SID={{ current_sid }}
        sqlplus -s / as sysdba << 'EOSQL'
        SET LINESIZE 500
        SET PAGESIZE 100
        SET HEADING ON
        SET FEEDBACK OFF
        COL username FORMAT A30
        COL account_status FORMAT A25
        COL default_tablespace FORMAT A20
        COL profile FORMAT A25
        SELECT 
          username,
          account_status,
          default_tablespace,
          profile,
          TO_CHAR(created, 'YYYY-MM-DD') as created,
          TO_CHAR(expiry_date, 'YYYY-MM-DD') as expiry_date
        FROM dba_users 
        WHERE UPPER(username) = UPPER('{{ check_user }}');
        EXIT;
        EOSQL
    become: yes
    become_user: "{{ _oracle_user }}"
    register: user_check_result
    failed_when: false
    when: check_user | default('') != ''

  - name: "{{ current_sid }} - Display user check result"
    ansible.builtin.debug:
      msg: |
        
        ========== USER CHECK: {{ check_user | upper }} in {{ current_sid }} ==========
        {% if user_check_result.stdout | default('') | trim == '' or 'no rows selected' in user_check_result.stdout | lower %}
        ⚠️  User '{{ check_user | upper }}' does NOT exist in {{ current_sid }}
        {% else %}
        ✅ User '{{ check_user | upper }}' EXISTS in {{ current_sid }}
        {{ user_check_result.stdout }}
        {% endif %}
        ============================================
    when: check_user | default('') != ''

  # ============================================
  # Change user password (optional)
  # Usage: -e "change_password_user=USERNAME change_password_new=NEWPASSWORD db_sid=SPECIFIC_SID"
  # ============================================
  - name: "{{ current_sid }} - Change user password"
    ansible.builtin.shell:
      cmd: |
        export ORACLE_HOME={{ _current_oracle_home }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export ORACLE_SID={{ current_sid }}
        sqlplus -s / as sysdba << 'EOSQL'
        SET HEADING OFF
        SET FEEDBACK ON
        ALTER USER {{ change_password_user }} IDENTIFIED BY "{{ change_password_new }}";
        EXIT;
        EOSQL
    become: yes
    become_user: "{{ _oracle_user }}"
    register: password_change_result
    failed_when: "'ORA-' in password_change_result.stdout"
    when: 
      - change_password_user | default('') != ''
      - change_password_new | default('') != ''
      - db_sid | default('') == current_sid or db_sid | default('') == ''
    no_log: true

  - name: "{{ current_sid }} - Display password change result"
    ansible.builtin.debug:
      msg: "✅ Password changed for '{{ change_password_user | upper }}' in {{ current_sid }}"
    when:
      - change_password_user | default('') != ''
      - change_password_new | default('') != ''
      - password_change_result is defined
      - password_change_result is succeeded

  # ============================================
  # Unlock user account (optional)
  # Usage: -e "unlock_user=USERNAME db_sid=SPECIFIC_SID"
  # ============================================
  - name: "{{ current_sid }} - Unlock user account"
    ansible.builtin.shell:
      cmd: |
        export ORACLE_HOME={{ _current_oracle_home }}
        export PATH=$ORACLE_HOME/bin:$PATH
        export ORACLE_SID={{ current_sid }}
        sqlplus -s / as sysdba << 'EOSQL'
        SET HEADING OFF
        SET FEEDBACK ON
        ALTER USER {{ unlock_user }} ACCOUNT UNLOCK;
        EXIT;
        EOSQL
    become: yes
    become_user: "{{ _oracle_user }}"
    register: unlock_result
    failed_when: "'ORA-' in unlock_result.stdout"
    when: 
      - unlock_user | default('') != ''
      - db_sid | default('') == current_sid or db_sid | default('') == ''

  - name: "{{ current_sid }} - Display unlock result"
    ansible.builtin.debug:
      msg: "✅ Account unlocked for '{{ unlock_user | upper }}' in {{ current_sid }}"
    when: 
      - unlock_user | default('') != ''
      - unlock_result is defined
      - unlock_result is succeeded
