---
# Setup cron job for continuous log sync
#

  - name: Create sync script on target host
    ansible.builtin.copy:
      dest: "/tmp/oracle_log_sync_{{ inventory_hostname }}.sh"
      mode: '0755'
      content: |
        #!/bin/bash
        # Oracle Log Sync Script - Auto-generated by Ansible
        # Host: {{ inventory_hostname }}
        # Generated: {{ ansible_date_time.iso8601 }}
        # Platform: AIX
        
        LOG_FILE="/var/log/oracle_log_sync.log"
        NFS_PATH="{{ nfs_log_path }}"
        HOSTNAME="{{ inventory_hostname }}"
        
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting Oracle log sync" >> $LOG_FILE
        
        # Check NFS mount
        if ! df -g "$NFS_PATH" > /dev/null 2>&1; then
          echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: NFS path $NFS_PATH not mounted" >> $LOG_FILE
          exit 1
        fi
        
        # Detect Oracle user (exclude grep from results)
        ORACLE_USER=$(ps -eo user,args | grep 'ora_pmon_' | grep -v grep | head -1 | awk '{print $1}')
        
        # Get all running instances (using sed instead of awk -F for AIX compatibility)
        INSTANCES=$(ps -ef | grep 'ora_pmon_' | grep -v grep | sed 's/.*ora_pmon_//' | awk '{print $1}')
        
        for SID in $INSTANCES; do
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Processing instance: $SID" >> $LOG_FILE
          
          # Get ORACLE_HOME from oratab
          ORACLE_HOME=$(grep "^${SID}:" /etc/oratab | cut -d':' -f2)
          
          if [ -z "$ORACLE_HOME" ]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - WARNING: No ORACLE_HOME for $SID" >> $LOG_FILE
            continue
          fi
          
          export ORACLE_HOME
          export ORACLE_SID=$SID
          export PATH=$ORACLE_HOME/bin:$PATH
          
          # Get diagnostic dest
          DIAG_TRACE=$(su - $ORACLE_USER -c "export ORACLE_HOME=$ORACLE_HOME; export ORACLE_SID=$SID; $ORACLE_HOME/bin/sqlplus -s / as sysdba <<EOF
SET HEADING OFF
SET FEEDBACK OFF
SELECT value FROM v$diag_info WHERE name = 'Diag Trace';
EXIT;
EOF" 2>/dev/null | tr -d ' ')
          
          # Get audit dest
          AUDIT_DEST=$(su - $ORACLE_USER -c "export ORACLE_HOME=$ORACLE_HOME; export ORACLE_SID=$SID; $ORACLE_HOME/bin/sqlplus -s / as sysdba <<EOF
SET HEADING OFF
SET FEEDBACK OFF
SELECT value FROM v$parameter WHERE name = 'audit_file_dest';
EXIT;
EOF" 2>/dev/null | tr -d ' ')
          
          # Create directories
          mkdir -p "$NFS_PATH/$HOSTNAME/$SID/alert" 2>/dev/null
          mkdir -p "$NFS_PATH/$HOSTNAME/$SID/audit" 2>/dev/null
          
          # Sync alert logs (incremental)
          if [ -d "$DIAG_TRACE" ]; then
            rsync -avz --update --include='alert_*.log' --include='alert_*.xml' --exclude='*' \
              "$DIAG_TRACE/" "$NFS_PATH/$HOSTNAME/$SID/alert/" >> $LOG_FILE 2>&1
          fi
          
          # Sync audit logs (incremental)
          if [ -d "$AUDIT_DEST" ]; then
            rsync -avz --update --include='*.aud' --include='*.xml' --exclude='*' \
              "$AUDIT_DEST/" "$NFS_PATH/$HOSTNAME/$SID/audit/" >> $LOG_FILE 2>&1
          fi
        done
        
        # Sync listener logs
        # Listener names include port: mrptprs.1611, mafp1wp.1651
        # Exclude grid infrastructure listeners (LISTENER, MGMTLSNR) and grid-owned processes
        LISTENERS=$(ps -ef | grep tnslsnr | grep -v grep | grep -v MGMTLSNR | while read line; do
          owner=$(echo "$line" | awk '{print $1}')
          # Only process listeners owned by oracle user (not grid)
          if [ "$owner" = "$ORACLE_USER" ]; then
            # Keep full listener name with port (e.g., mrptprs.1611)
            lsnr_name=$(echo "$line" | sed 's/.*tnslsnr //' | awk '{print $1}')
            # Skip generic LISTENER name
            if [ "$lsnr_name" != "LISTENER" ]; then
              echo "$lsnr_name"
            fi
          fi
        done | sort -u)
        
        for LSNR in $LISTENERS; do
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Processing listener: $LSNR" >> $LOG_FILE
          mkdir -p "$NFS_PATH/$HOSTNAME/listener/$LSNR" 2>/dev/null
          
          # Find listener log directory
          ORACLE_BASE=$(grep -v '^#' /etc/oratab | grep ':' | head -1 | awk -F':' '{print $2}' | sed 's|/product.*||')
          HOSTNAME_SHORT=$(hostname | cut -d'.' -f1 | tr '[:upper:]' '[:lower:]')
          # Convert listener name to lowercase for directory matching
          LSNR_LOWER=$(echo "$LSNR" | tr '[:upper:]' '[:lower:]')
          
          # Try multiple possible locations
          for LSNR_DIR in \
            "${ORACLE_BASE}/diag/tnslsnr/${HOSTNAME_SHORT}/${LSNR_LOWER}/trace" \
            "${ORACLE_BASE}/diag/tnslsnr/${HOSTNAME_SHORT}/${LSNR}/trace" \
            "/u01/mod/oracle/diag/tnslsnr/${HOSTNAME_SHORT}/${LSNR_LOWER}/trace"; do
            if [ -d "$LSNR_DIR" ]; then
              rsync -avz --update --include='*.log' --include='*.xml' --exclude='*' \
                "$LSNR_DIR/" "$NFS_PATH/$HOSTNAME/listener/$LSNR/" >> $LOG_FILE 2>&1
              break
            fi
          done
        done
        
        {% if log_retention_days > 0 %}
        # Cleanup old logs on NFS (retention: {{ log_retention_days }} days)
        find "$NFS_PATH/$HOSTNAME" -type f -mtime +{{ log_retention_days }} -delete 2>/dev/null
        {% endif %}
        
        {% if compress_logs %}
        # Compress logs older than 1 day
        find "$NFS_PATH/$HOSTNAME" -type f \( -name "*.log" -o -name "*.trc" -o -name "*.aud" \) -mtime +1 ! -name "*.gz" -exec gzip {} \; 2>/dev/null
        {% endif %}
        
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Oracle log sync completed" >> $LOG_FILE
    # become removed: already running as oracle

  - name: Deploy sync script to permanent location
    ansible.builtin.copy:
      src: "/tmp/oracle_log_sync_{{ inventory_hostname }}.sh"
      dest: "/usr/local/bin/oracle_log_sync.sh"
      remote_src: yes
      mode: '0755'
      owner: root
      group: system
    # become removed: already running as oracle

  - name: Setup cron job for continuous sync (AIX)
    ansible.builtin.cron:
      name: "Oracle Log Sync to NFS"
      minute: "*/{{ cron_interval }}"
      job: "/usr/local/bin/oracle_log_sync.sh"
      user: root
      state: present
    # become removed: already running as oracle

  - name: Display cron setup status
    ansible.builtin.debug:
      msg: |
        Cron job configured:
        - Script: /usr/local/bin/oracle_log_sync.sh
        - Interval: Every {{ cron_interval }} minutes
        - Log file: /var/log/oracle_log_sync.log
