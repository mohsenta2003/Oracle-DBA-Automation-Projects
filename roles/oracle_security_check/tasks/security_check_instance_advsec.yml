---
# roles/oracle_security_check/tasks/security_check_instance_advsec.yml
# Enhanced Advanced Security check using improved query
# Called from main.yml with loop_var: current_sid

- name: "{{ current_sid }} - Get ORACLE_HOME"
  ansible.builtin.set_fact:
    _current_oracle_home: "{{ _oratab_map[current_sid] | default(_oratab_map.values() | first) }}"

- name: "{{ current_sid }} - Display instance info"
  ansible.builtin.debug:
    msg: "Checking security features: {{ current_sid }} | ORACLE_HOME: {{ _current_oracle_home }}"

# ============================================
# Check Database Status and Role
# ============================================
- name: "{{ current_sid }} - Check database status and role"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT status || '|' || database_role || '|' || open_mode FROM v$instance, v$database;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: db_status_check
  failed_when: false

- name: "{{ current_sid }} - Parse database status"
  ansible.builtin.set_fact:
    _db_status: "{{ (db_status_check.stdout | default('UNKNOWN|UNKNOWN|UNKNOWN') | trim).split('|')[0] | default('UNKNOWN') }}"
    _db_role: "{{ (db_status_check.stdout | default('UNKNOWN|UNKNOWN|UNKNOWN') | trim).split('|')[1] | default('UNKNOWN') }}"
    _db_open_mode: "{{ (db_status_check.stdout | default('UNKNOWN|UNKNOWN|UNKNOWN') | trim).split('|')[2] | default('UNKNOWN') }}"

- name: "{{ current_sid }} - Debug database connection failure"
  ansible.builtin.debug:
    msg: 
      - "WARNING: Connection to {{ current_sid }} failed or returned empty status."
      - "Return Code: {{ db_status_check.rc | default('N/A') }}"
      - "Stdout: {{ db_status_check.stdout | default('N/A') }}"
      - "Stderr: {{ db_status_check.stderr | default('N/A') }}"
  when: db_status_check.rc | default(0) != 0 or db_status_check.stdout | trim == ""

- name: "{{ current_sid }} - Display database status"
  ansible.builtin.debug:
    msg: "Database {{ current_sid }}: Status={{ _db_status }}, Role={{ _db_role }}, Open Mode={{ _db_open_mode }}"

# ============================================
# Refresh Feature Usage Statistics
# ============================================
- name: "{{ current_sid }} - Refresh feature usage statistics"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      WHENEVER SQLERROR EXIT SQL.SQLCODE
      BEGIN
        DBMS_FEATURE_USAGE_INTERNAL.exec_db_usage_sampling(SYSDATE);
      END;
      /
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: advsec_refresh_output
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

# ============================================
# Check Advanced Security Features (Only for OPEN databases)
# ============================================
- name: "{{ current_sid }} - Check Advanced Security Features"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET PAGESIZE 100
      SET LINESIZE 200
      SET HEADING ON
      SET FEEDBACK OFF
      COLUMN "Server" FORMAT A15
      COLUMN "Instance" FORMAT A12
      COLUMN "Feature Name" FORMAT A30
      COLUMN "Installed?" FORMAT A11
      COLUMN "In-Use?" FORMAT A8
      COLUMN "Usage Details" FORMAT A35
      COLUMN "Audit Date" FORMAT A12
      
      SELECT 
        (SELECT host_name FROM v$instance) AS "Server",
        (SELECT instance_name FROM v$instance) AS "Instance",
        o.parameter AS "Feature Name",
        o.value AS "Installed?",
        CASE 
          WHEN o.parameter = 'Transparent Data Encryption' AND (SELECT COUNT(*) FROM dba_tablespaces WHERE encrypted = 'YES') > 0 THEN 'YES'
          WHEN o.parameter = 'Data Redaction' AND (SELECT COUNT(*) FROM redaction_policies) > 0 THEN 'YES'
          WHEN o.parameter = 'Backup Encryption' AND (SELECT COUNT(*) FROM v$backup_piece WHERE encrypted='YES') > 0 THEN 'YES'
          WHEN o.parameter = 'SecureFiles Encryption' AND (SELECT COUNT(*) FROM dba_lobs WHERE encrypt='YES') > 0 THEN 'YES'
          ELSE 'NO'
        END AS "In-Use?",
        CASE 
          WHEN o.parameter = 'Transparent Data Encryption' THEN 
            NVL((SELECT 'TBS: ' || LISTAGG(tablespace_name, ', ') WITHIN GROUP (ORDER BY tablespace_name) 
                 FROM dba_tablespaces WHERE encrypted = 'YES'), 'Ready')
          WHEN o.parameter = 'Data Redaction' THEN 
            (SELECT 'Policies: ' || COUNT(*) FROM redaction_policies)
          WHEN o.parameter = 'Backup Encryption' THEN 
            (SELECT 'Backups: ' || COUNT(*) FROM v$backup_piece WHERE encrypted='YES')
          WHEN o.parameter = 'SecureFiles Encryption' THEN 
            (SELECT 'LOBs: ' || COUNT(*) FROM dba_lobs WHERE encrypt='YES')
          ELSE 'Ready'
        END AS "Usage Details",
        (SELECT TO_CHAR(MAX(last_sample_date), 'YYYY-MM-DD') 
         FROM dba_feature_usage_statistics 
         WHERE name = o.parameter) AS "Audit Date"
      FROM v$option o
      WHERE o.parameter IN ('Transparent Data Encryption', 'Data Redaction', 'Backup Encryption', 'SecureFiles Encryption')
      ORDER BY "In-Use?" DESC, "Feature Name";
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: security_features_output
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

- name: "{{ current_sid }} - Set output for standby/mounted database"
  ansible.builtin.set_fact:
    security_features_output:
      stdout: "DATABASE IS IN {{ _db_open_mode }} MODE (Role: {{ _db_role }}) - Cannot query advanced security features"
  when: _db_open_mode is not search('READ') and _db_status != 'OPEN'

# ============================================
# Check Individual Feature Status for Reporting
# ============================================


- name: "{{ current_sid }} - Check TDE status"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT CASE WHEN COUNT(*) > 0 THEN 'TRUE' ELSE 'FALSE' END FROM dba_tablespaces WHERE encrypted = 'YES';
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: tde_status
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

- name: "{{ current_sid }} - Check Data Redaction status"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT CASE WHEN COUNT(*) > 0 THEN 'TRUE' ELSE 'FALSE' END FROM redaction_policies;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: redaction_status
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

- name: "{{ current_sid }} - Check Backup Encryption status"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT CASE WHEN COUNT(*) > 0 THEN 'TRUE' ELSE 'FALSE' END FROM v$backup_piece WHERE encrypted='YES';
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: backup_enc_status
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

- name: "{{ current_sid }} - Check SecureFiles Encryption status"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT CASE WHEN COUNT(*) > 0 THEN 'TRUE' ELSE 'FALSE' END FROM dba_lobs WHERE encrypt='YES';
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: securefiles_enc_status
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

# ============================================
# Save Instance Report
# ============================================

- name: "{{ current_sid }} - Set feature usage variables"
  ansible.builtin.set_fact:
    _tde_in_use: "{{ 'TRUE' in (((tde_status | default({})).get('stdout', '')) | upper) }}"
    _redaction_in_use: "{{ 'TRUE' in (((redaction_status | default({})).get('stdout', '')) | upper) }}"
    _backup_enc_in_use: "{{ 'TRUE' in (((backup_enc_status | default({})).get('stdout', '')) | upper) }}"
    _securefiles_enc_in_use: "{{ 'TRUE' in (((securefiles_enc_status | default({})).get('stdout', '')) | upper) }}"

- name: "{{ current_sid }} - Set report filename variables"
  ansible.builtin.set_fact:
    _current_report_file: "security_check_{{ group_names | default(['all']) | first | lower }}_{{ current_sid }}_{{ _report_timestamp }}.txt"
    _current_html_report_file: "security_check_{{ group_names | default(['all']) | first | lower }}_{{ current_sid }}_{{ _report_timestamp }}.html"

- name: "{{ current_sid }} - Save security check report"
  ansible.builtin.copy:
    content: |
      ================================================================================
                  ORACLE ADVANCED SECURITY FEATURES REPORT
      ================================================================================
      Playbook:    {{ ansible_play_name | default('Oracle Security Check') }}
      Inventory:   {{ group_names | join(', ') | default('all') }}
      Host:        {{ inventory_hostname }}
      Database:    {{ current_sid }}
      Oracle User: {{ _oracle_user }}
      ORACLE_HOME: {{ _current_oracle_home }}
      DB Status:   {{ _db_status }}
      DB Role:     {{ _db_role }}
      Open Mode:   {{ _db_open_mode }}
      Generated:   {{ ansible_date_time.iso8601 }}
      ================================================================================
      
      Features Checked:
      - Transparent Data Encryption (TDE)
      - Data Redaction
      - Backup Encryption
      - SecureFiles Encryption
      
      ================================================================================
      FEATURE USAGE STATUS
      ================================================================================
      {{ security_features_output.stdout | default('Unable to retrieve feature usage data') }}
      
      ================================================================================
      QUICK SUMMARY
      ================================================================================
      Features Installed:     4 (All Advanced Security features available)
      Features In-Use:        {{ (1 if (_tde_in_use | default(false)) else 0) + (1 if (_redaction_in_use | default(false)) else 0) + (1 if (_backup_enc_in_use | default(false)) else 0) + (1 if (_securefiles_enc_in_use | default(false)) else 0) }} of 4
      Last Analysis:          {{ ansible_date_time.iso8601 }}
      
      Feature Status:
      - TDE Encryption:         {{ 'IN-USE ‚úì' if (_tde_in_use | default(false)) else 'NOT USED' }}
      - Data Redaction:         {{ 'IN-USE ‚úì' if (_redaction_in_use | default(false)) else 'NOT USED' }}
      - Backup Encryption:      {{ 'IN-USE ‚úì' if (_backup_enc_in_use | default(false)) else 'NOT USED' }}
      - SecureFiles Encryption: {{ 'IN-USE ‚úì' if (_securefiles_enc_in_use | default(false)) else 'NOT USED' }}
      
      License Required:       {{ 'YES - Advanced Security License needed' if (_tde_in_use | default(false)) or (_redaction_in_use | default(false)) or (_backup_enc_in_use | default(false)) or (_securefiles_enc_in_use | default(false)) else 'NO' }}
      
      ================================================================================
      LEGEND
      ================================================================================
      "Installed?" = Feature is installed/licensed in Oracle
      "In-Use?"    = Feature is actively configured and in use
      "Usage Details" = Specific usage information:
                        - TDE: Lists encrypted tablespaces
                        - Data Redaction: Number of active policies
                        - Backup Encryption: Number of encrypted backup pieces
                        - SecureFiles Encryption: Number of encrypted LOBs
      "Audit Date" = Last sample date from dba_feature_usage_statistics
      
      Note: This enhanced check verifies actual usage by querying real 
            configurations (encrypted tablespaces, redaction policies, 
            encrypted backups, encrypted LOBs) rather than relying solely 
            on dba_feature_usage_statistics.
      
      ================================================================================
                                  END OF REPORT
      ================================================================================
    dest: "{{ _local_report_dir }}/{{ _current_report_file }}"
  delegate_to: localhost
  become: no

- name: "{{ current_sid }} - Get TDE Wallet Details"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT wrl_type || '|' || status || '|' || wallet_type || '|' || wrl_parameter FROM v$encryption_wallet;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: tde_wallet_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN')

- name: "{{ current_sid }} - Get TDE Parameters"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SET LINESIZE 200
      SELECT name || '|' || value FROM v$parameter 
      WHERE name IN (
        'encrypt_new_tablespaces', 
        'wallet_root', 
        'tde_configuration', 
        'tablespace_encryption_default_algorithm',
        'sqlnet.encryption_server', 
        'sqlnet.encryption_types_server',
        'sqlnet.encryption_client',
        'sqlnet.encryption_types_client'
      ) ORDER BY name;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: tde_parameters_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN')

- name: "{{ current_sid }} - Get Encrypted Tablespaces Details"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT ts.name || '|' || e.ENCRYPTIONALG 
      FROM v$tablespace ts, v$encrypted_tablespaces e 
      WHERE ts.ts# = e.ts#;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: tde_tablespace_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN') and (_tde_in_use | bool)

- name: "{{ current_sid }} - Get Data Redaction Details"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT c.object_owner || '.' || c.object_name || '|' || c.column_name || '|' || p.policy_name || '|' || p.enable 
      FROM redaction_columns c, redaction_policies p 
      WHERE c.object_owner = p.object_owner 
        AND c.object_name = p.object_name;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: redaction_policy_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN') and (_redaction_in_use | bool)

- name: "{{ current_sid }} - Get RMAN Encryption Details"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT name || '|' || value FROM v$rman_configuration WHERE name LIKE '%ENCRYPTION%';
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: rman_encryption_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN') and (_backup_enc_in_use | bool)

- name: "{{ current_sid }} - Get SecureFiles Details"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SELECT owner || '.' || table_name || '|' || column_name || '|' || encrypt FROM dba_lobs WHERE encrypt='YES';
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: securefiles_details
  failed_when: false
  when: (_db_open_mode is search('READ') or _db_status == 'OPEN') and (_securefiles_enc_in_use | bool)

# ============================================
# Get Summary Data for Consolidated Report
# ============================================
- name: "{{ current_sid }} - Get summary status (Installed and Audit Date)"
  ansible.builtin.shell:
    cmd: |
      export ORACLE_HOME={{ _current_oracle_home }}
      export PATH=$ORACLE_HOME/bin:$PATH
      export ORACLE_SID={{ current_sid }}
      sqlplus -s / as sysdba << 'EOSQL'
      SET HEADING OFF
      SET FEEDBACK OFF
      SET PAGESIZE 0
      SET LINESIZE 1000
      SELECT 
        (SELECT value FROM v$option WHERE parameter = 'Transparent Data Encryption') || '|' ||
        (SELECT value FROM v$option WHERE parameter = 'Data Redaction') || '|' ||
        (SELECT value FROM v$option WHERE parameter = 'Backup Encryption') || '|' ||
        (SELECT value FROM v$option WHERE parameter = 'SecureFiles Encryption') || '|' ||
        (SELECT NVL(TO_CHAR(first_usage_date, 'YYYY-MM-DD'), NVL(TO_CHAR(last_sample_date, 'YYYY-MM-DD'), 'Never')) FROM dba_feature_usage_statistics WHERE name = 'Transparent Data Encryption' AND rownum=1) || '|' ||
        (SELECT NVL(TO_CHAR(first_usage_date, 'YYYY-MM-DD'), NVL(TO_CHAR(last_sample_date, 'YYYY-MM-DD'), 'Never')) FROM dba_feature_usage_statistics WHERE name = 'Data Redaction' AND rownum=1) || '|' ||
        (SELECT NVL(TO_CHAR(first_usage_date, 'YYYY-MM-DD'), NVL(TO_CHAR(last_sample_date, 'YYYY-MM-DD'), 'Never')) FROM dba_feature_usage_statistics WHERE name = 'Backup Encryption' AND rownum=1) || '|' ||
        (SELECT NVL(TO_CHAR(first_usage_date, 'YYYY-MM-DD'), NVL(TO_CHAR(last_sample_date, 'YYYY-MM-DD'), 'Never')) FROM dba_feature_usage_statistics WHERE name = 'SecureFiles Encryption' AND rownum=1) || '|' ||
        (SELECT TO_CHAR(COUNT(*)) FROM v$encrypted_tablespaces) || '|' ||
        (SELECT TO_CHAR(COUNT(*)) FROM redaction_policies) || '|' ||
        (SELECT TO_CHAR(COUNT(*)) FROM v$backup_piece WHERE encrypted='YES') || '|' ||
        (SELECT TO_CHAR(COUNT(*)) FROM dba_lobs WHERE encrypt='YES') || '|' ||
        (SELECT NVL(SUBSTR(LISTAGG(tablespace_name, ', ') WITHIN GROUP (ORDER BY tablespace_name), 1, 100), 'None') FROM dba_tablespaces WHERE encrypted = 'YES')
      FROM DUAL;
      EXIT;
      EOSQL
  become: yes
  become_user: "{{ _oracle_user }}"
  register: summary_status_output
  failed_when: false
  when: _db_open_mode is search('READ') or _db_status == 'OPEN'

- name: "{{ current_sid }} - Parse summary status safely"
  ansible.builtin.set_fact:
    _raw_summary_list: "{{ (summary_status_output.stdout | default('FALSE|FALSE|FALSE|FALSE|Never|Never|Never|Never|0|0|0|0|None')).split('|') }}"

- name: "{{ current_sid }} - Ensure summary list has enough elements"
  ansible.builtin.set_fact:
    _safe_summary_list: "{{ _raw_summary_list + ['FALSE', 'FALSE', 'FALSE', 'FALSE', 'Never', 'Never', 'Never', 'Never', '0', '0', '0', '0', 'None'][_raw_summary_list|length:] }}"

- name: "{{ current_sid }} - Save security check report (HTML)"
  ansible.builtin.copy:
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Security Check: {{ current_sid }}</title>
          <style>
              :root {
                  --primary: #1e3a8a;
                  --bg-gray: #f8fafc;
                  --border: #e2e8f0;
                  --text-main: #1e293b;
                  --text-muted: #64748b;
                  --status-used-bg: #fee2e2;
                  --status-used-text: #991b1b;
                  --status-not-used-bg: #f1f5f9;
                  --status-not-used-text: #475569;
              }
              body { font-family: 'Inter', -apple-system, system-ui, sans-serif; background-color: #f1f5f9; color: var(--text-main); margin: 0; padding: 40px; line-height: 1.5; }
              .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
              h1 { color: var(--primary); font-size: 1.75rem; border-bottom: 2px solid var(--bg-gray); padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
              h2 { font-size: 1.25rem; color: #334155; margin-top: 40px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px; }
              
              .header-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; background: var(--bg-gray); padding: 25px; border-radius: 8px; border: 1px solid var(--border); }
              .info-item strong { color: var(--text-muted); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 5px; }
              .info-item span { font-weight: 600; color: var(--text-main); }

              .status-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
              .status-in-use { background-color: var(--status-used-bg); color: var(--status-used-text); border: 1px solid #fecaca; }
              .status-not-used { background-color: var(--status-not-used-bg); color: var(--status-not-used-text); border: 1px solid var(--border); }
              
              table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; table-layout: auto; }
              th { background-color: #f8fafc; color: var(--text-muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 14px 16px; text-align: left; border-bottom: 2px solid var(--border); }
              td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 0.875rem; vertical-align: middle; }
              tr:last-child td { border-bottom: none; }
              tr:hover { background-color: #fcfdfe; }

              .col-feature { font-weight: 600; color: var(--primary); min-width: 180px; }
              .col-status { text-align: center; width: 100px; }
              .col-date { color: var(--text-muted); width: 110px; text-align: center; }
              .col-count { text-align: center; width: 90px; }
              .col-license { text-align: center; font-weight: 700; width: 80px; }
              .col-details { color: var(--text-muted); font-size: 0.8rem; }

              pre { background: #0f172a; color: #f8fafc; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: 'Fira Code', 'Cascadia Code', monospace; font-size: 0.85rem; margin-top: 20px; border: 1px solid #1e293b; }
              .footer { margin-top: 50px; padding-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem; border-top: 1px solid var(--border); }
              
              .section-title { font-size: 1.1rem; font-weight: 600; margin-top: 40px; padding-bottom: 10px; border-bottom: 1px solid var(--border); color: var(--primary); }
              .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
              .config-item { background: white; padding: 15px; border-radius: 6px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
              .config-label { font-weight: 600; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 5px; }
              .config-value { font-family: monospace; color: var(--text-main); font-size: 0.9rem; word-break: break-all; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>üõ°Ô∏è Oracle Advanced Security Report</h1>
              
              <div class="header-info">
                  <div class="info-item"><strong>Host</strong> {{ inventory_hostname }}</div>
                  <div class="info-item"><strong>Database</strong> {{ current_sid }}</div>
                  <div class="info-item"><strong>DB Role</strong> {{ _db_role }}</div>
                  <div class="info-item"><strong>Date</strong> {{ ansible_date_time.iso8601 }}</div>
              </div>

              <h2>Feature Status</h2>
              <table>
                  <thead>
                      <tr>
                          <th class="col-feature">Feature</th>
                          <th class="col-status">Status</th>
                          <th class="col-date">First Used</th>
                          <th class="col-count">Count</th>
                          <th class="col-details">Details</th>
                          <th class="col-license">License?</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% set summary_parts = (summary_status_output | default({})).get('stdout', '').split('|') %}
                      <tr>
                          <td class="col-feature">TDE Encryption</td>
                          <td class="col-status">
                              {% if _tde_in_use | default(false) %}<span class="status-badge status-in-use">IN USE</span>
                              {% else %}<span class="status-badge status-not-used">NOT USED</span>{% endif %}
                          </td>
                          <td class="col-date">{{ summary_parts[4] if summary_parts | length > 4 else 'Never' }}</td>
                          <td class="col-count">{{ summary_parts[8] if summary_parts | length > 8 else '0' }}</td>
                          <td class="col-details">
                              {% if _tde_in_use | default(false) %}
                              <strong>Tablespaces:</strong> {{ summary_parts[12] if summary_parts | length > 12 else 'None' }}
                              {% else %}N/A{% endif %}
                          </td>
                          <td class="col-license" style="color: {{ '#ef4444' if _tde_in_use | default(false) else '#94a3b8' }};">{{ 'YES' if _tde_in_use | default(false) else 'NO' }}</td>
                      </tr>
                      <tr>
                          <td class="col-feature">Data Redaction</td>
                          <td class="col-status">
                              {% if _redaction_in_use | default(false) %}<span class="status-badge status-in-use">IN USE</span>
                              {% else %}<span class="status-badge status-not-used">NOT USED</span>{% endif %}
                          </td>
                          <td class="col-date">{{ summary_parts[5] if summary_parts | length > 5 else 'Never' }}</td>
                          <td class="col-count">{{ summary_parts[9] if summary_parts | length > 9 else '0' }}</td>
                          <td class="col-details">
                              {% if _redaction_in_use | default(false) %}
                              <strong>Policies:</strong> {{ (summary_status_output | default({})).get('stdout', '').split('|')[9] | default('0') }}
                              {% else %}N/A{% endif %}
                          </td>
                          <td class="col-license" style="color: {{ '#ef4444' if _redaction_in_use | default(false) else '#94a3b8' }};">{{ 'YES' if _redaction_in_use | default(false) else 'NO' }}</td>
                      </tr>
                      <tr>
                          <td class="col-feature">Backup Encryption</td>
                          <td class="col-status">
                              {% if _backup_enc_in_use | default(false) %}<span class="status-badge status-in-use">IN USE</span>
                              {% else %}<span class="status-badge status-not-used">NOT USED</span>{% endif %}
                          </td>
                          <td class="col-date">{{ summary_parts[6] if summary_parts | length > 6 else 'Never' }}</td>
                          <td class="col-count">{{ summary_parts[10] if summary_parts | length > 10 else '0' }}</td>
                          <td class="col-details">
                              {% if _backup_enc_in_use | default(false) %}
                              <strong>Pieces:</strong> {{ (summary_status_output | default({})).get('stdout', '').split('|')[10] | default('0') }}
                              {% else %}N/A{% endif %}
                          </td>
                          <td class="col-license" style="color: {{ '#ef4444' if _backup_enc_in_use | default(false) else '#94a3b8' }};">{{ 'YES' if _backup_enc_in_use | default(false) else 'NO' }}</td>
                      </tr>
                      <tr>
                          <td class="col-feature">SecureFiles Encryption</td>
                          <td class="col-status">
                              {% if _securefiles_enc_in_use | default(false) %}<span class="status-badge status-in-use">IN USE</span>
                              {% else %}<span class="status-badge status-not-used">NOT USED</span>{% endif %}
                          </td>
                          <td class="col-date">{{ summary_parts[7] if summary_parts | length > 7 else 'Never' }}</td>
                          <td class="col-count">{{ summary_parts[11] if summary_parts | length > 11 else '0' }}</td>
                          <td class="col-details">
                              {% if _securefiles_enc_in_use | default(false) %}
                              <strong>LOBs:</strong> {{ (summary_status_output | default({})).get('stdout', '').split('|')[11] | default('0') }}
                              {% else %}N/A{% endif %}
                          </td>
                          <td class="col-license" style="color: {{ '#ef4444' if _securefiles_enc_in_use | default(false) else '#94a3b8' }};">{{ 'YES' if _securefiles_enc_in_use | default(false) else 'NO' }}</td>
                      </tr>
                  </tbody>
              </table>

              {% if _tde_in_use | default(false) or (tde_wallet_details.stdout_lines is defined and tde_wallet_details.stdout_lines | length > 0) %}
              <div class="section">
                  <h2 class="section-title">üîê TDE Configuration Details</h2>
                  
                  <h4>Wallet Status</h4>
                  {% if tde_wallet_details.stdout_lines is defined and tde_wallet_details.stdout_lines | length > 0 %}
                  {% set wallet = tde_wallet_details.stdout_lines[0].split('|') %}
                  <div class="config-grid">
                      <div class="config-item">
                          <span class="config-label">Wallet Type</span>
                          <span class="config-value">{{ wallet[0] if wallet | length > 0 else 'N/A' }} / {{ wallet[2] if wallet | length > 2 else 'N/A' }}</span>
                      </div>
                      <div class="config-item">
                          <span class="config-label">Status</span>
                          <span class="config-value">{{ wallet[1] if wallet | length > 1 else 'N/A' }}</span>
                      </div>
                      <div class="config-item" style="grid-column: span 2;">
                          <span class="config-label">Location (WRL_PARAMETER)</span>
                          <span class="config-value">{{ wallet[3] if wallet | length > 3 else 'N/A' }}</span>
                      </div>
                  </div>
                  {% else %}
                  <p><em>No wallet information available (or TDE not used).</em></p>
                  {% endif %}

                  <h4>Initialization Parameters</h4>
                  {% if tde_parameters_details.stdout_lines is defined and tde_parameters_details.stdout_lines | length > 0 %}
                  <table>
                      <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
                      <tbody>
                      {% for line in tde_parameters_details.stdout_lines %}
                      {% set param = line.split('|') %}
                      <tr>
                          <td>{{ param[0] if param | length > 0 else 'N/A' }}</td>
                          <td>{{ param[1] if param | length > 1 else 'N/A' }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                  {% else %}
                  <p><em>No relevant TDE parameters found.</em></p>
                  {% endif %}

                  {% if _tde_in_use | default(false) %}
                  <h4>Encrypted Tablespaces</h4>
                  {% if tde_tablespace_details.stdout_lines is defined and tde_tablespace_details.stdout_lines | length > 0 %}
                  <table>
                      <thead><tr><th>Tablespace</th><th>Encryption Algorithm</th></tr></thead>
                      <tbody>
                      {% for line in tde_tablespace_details.stdout_lines %}
                      {% set tbs = line.split('|') %}
                      <tr>
                          <td>{{ tbs[0] if tbs | length > 0 else 'N/A' }}</td>
                          <td>{{ tbs[1] if tbs | length > 1 else 'N/A' }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                  {% else %}
                  <p><em>No encrypted tablespaces found (despite TDE flag).</em></p>
                  {% endif %}
                  {% endif %}
              </div>
              {% endif %}

              {% if _redaction_in_use | default(false) %}
              <div class="section">
                  <h2 class="section-title">üõ°Ô∏è Data Redaction Details</h2>
                  {% if redaction_policy_details.stdout_lines is defined and redaction_policy_details.stdout_lines | length > 0 %}
                  <table>
                      <thead><tr><th>Object</th><th>Column</th><th>Policy</th><th>Enabled</th></tr></thead>
                      <tbody>
                      {% for line in redaction_policy_details.stdout_lines %}
                      {% set row = line.split('|') %}
                      <tr>
                          <td>{{ row[0] if row | length > 0 else 'N/A' }}</td>
                          <td>{{ row[1] if row | length > 1 else 'N/A' }}</td>
                          <td>{{ row[2] if row | length > 2 else 'N/A' }}</td>
                          <td>{{ row[3] if row | length > 3 else 'N/A' }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                  {% else %}
                  <p><em>No specific redaction policies found.</em></p>
                  {% endif %}
              </div>
              {% endif %}

              {% if _backup_enc_in_use | default(false) %}
              <div class="section">
                  <h2 class="section-title">üíæ Backup Encryption Details</h2>
                  {% if rman_encryption_details.stdout_lines is defined and rman_encryption_details.stdout_lines | length > 0 %}
                  <table>
                      <thead><tr><th>RMAN Parameter</th><th>Value</th></tr></thead>
                      <tbody>
                      {% for line in rman_encryption_details.stdout_lines %}
                      {% set row = line.split('|') %}
                      <tr>
                          <td>{{ row[0] if row | length > 0 else 'N/A' }}</td>
                          <td>{{ row[1] if row | length > 1 else 'N/A' }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                  {% else %}
                  <p><em>No RMAN encryption configurations found.</em></p>
                  {% endif %}
              </div>
              {% endif %}

              {% if _securefiles_enc_in_use | default(false) %}
              <div class="section">
                  <h2 class="section-title">üìÅ SecureFiles Encryption Details</h2>
                  {% if securefiles_details.stdout_lines is defined and securefiles_details.stdout_lines | length > 0 %}
                  <table>
                      <thead><tr><th>Table.Column</th><th>Column</th><th>Encrypted</th></tr></thead>
                      <tbody>
                      {% for line in securefiles_details.stdout_lines %}
                      {% set row = line.split('|') %}
                      <tr>
                          <td>{{ row[0] if row | length > 0 else 'N/A' }}</td>
                          <td>{{ row[1] if row | length > 1 else 'N/A' }}</td>
                          <td>{{ row[2] if row | length > 2 else 'YES' }}</td>
                      </tr>
                      {% endfor %}
                      </tbody>
                  </table>
                  {% else %}
                  <p><em>No encrypted SecureFiles found.</em></p>
                  {% endif %}
              </div>
              {% endif %}

              <h2>Detailed Output</h2>
              <pre>{{ (security_features_output | default({})).get('stdout', 'Unable to retrieve feature usage data') }}</pre>

              <div class="footer">
                  Generated by Ansible Oracle Security Checks ‚Ä¢ {{ ansible_play_name | default('Security Playbook') }}
              </div>
          </div>
      </body>
      </html>
    dest: "{{ _local_report_dir }}/{{ _current_html_report_file }}"
  delegate_to: localhost
  become: no

# ============================================
# Get Summary Data for Consolidated Report
# ============================================


- name: "{{ current_sid }} - Calculate usage metrics"
  ansible.builtin.set_fact:
    _current_tde_used: "{{ 'TRUE' in (((tde_status | default({})).get('stdout', '')) | upper) }}"
    _current_red_used: "{{ 'TRUE' in (((redaction_status | default({})).get('stdout', '')) | upper) }}"
    _current_bkp_used: "{{ 'TRUE' in (((backup_enc_status | default({})).get('stdout', '')) | upper) }}"
    _current_sec_used: "{{ 'TRUE' in (((securefiles_enc_status | default({})).get('stdout', '')) | upper) }}"

- name: "{{ current_sid }} - Determine earliest start date"
  ansible.builtin.set_fact:
    _current_in_use_count: "{{ (1 if _current_tde_used | bool else 0) + (1 if _current_red_used | bool else 0) + (1 if _current_bkp_used | bool else 0) + (1 if _current_sec_used | bool else 0) }}"
    _current_start_date: >-
      {% set summary_parts = (summary_status_output | default({})).get('stdout', '').split('|') %}
      {% set dates = [] %}
      {% if _current_tde_used | bool %}{% set _ = dates.append(summary_parts[4] if summary_parts | length > 4 else 'Never') %}{% endif %}
      {% if _current_red_used | bool %}{% set _ = dates.append(summary_parts[5] if summary_parts | length > 5 else 'Never') %}{% endif %}
      {% if _current_bkp_used | bool %}{% set _ = dates.append(summary_parts[6] if summary_parts | length > 6 else 'Never') %}{% endif %}
      {% if _current_sec_used | bool %}{% set _ = dates.append(summary_parts[7] if summary_parts | length > 7 else 'Never') %}{% endif %}
      {% set filtered_dates = dates | select('match', '^[0-9]{4}-[0-9]{2}-[0-9]{2}$') | list | sort %}
      {{ filtered_dates[0] if filtered_dates | length > 0 else 'N/A' }}

- name: "{{ current_sid }} - Store result for consolidated report"
  ansible.builtin.set_fact:
    _instance_results: "{{ _instance_results | default([]) + [new_result_item] }}"
  vars:
    new_result_item:
      sid: "{{ current_sid }}"
      host: "{{ inventory_hostname }}"
      report_file: "{{ _current_html_report_file }}"
      oracle_home: "{{ _current_oracle_home | default('') }}"
      db_role: "{{ _db_role | default('UNKNOWN') }}"
      db_status: "{{ _db_status | default('UNKNOWN') }}"
      open_mode: "{{ _db_open_mode | default('UNKNOWN') }}"
      output: "{{ (security_features_output | default({})).get('stdout', 'Unable to retrieve data') }}"
      tde_installed: "{{ _safe_summary_list[0] | trim | default('FALSE') }}"
      redaction_installed: "{{ _safe_summary_list[1] | trim | default('FALSE') }}"
      backup_enc_installed: "{{ _safe_summary_list[2] | trim | default('FALSE') }}"
      securefiles_enc_installed: "{{ _safe_summary_list[3] | trim | default('FALSE') }}"
      audit_date: "{{ _safe_summary_list[4] | trim | default('UNKNOWN') }}"
      tde_details: "{{ _safe_summary_list[5] | trim | default('None') }}"
      redaction_details: "{{ _safe_summary_list[6] | trim | default('0') }}"
      backup_enc_details: "{{ _safe_summary_list[7] | trim | default('0') }}"
      securefiles_enc_details: "{{ _safe_summary_list[8] | trim | default('0') }}"
      tde_used: "{{ _current_tde_used | bool }}"
      redaction_used: "{{ _current_red_used | bool }}"
      backup_enc_used: "{{ _current_bkp_used | bool }}"
      securefiles_enc_used: "{{ _current_sec_used | bool }}"
      in_use_count: "{{ _current_in_use_count | int }}"
      start_date: "{{ _current_start_date | trim }}"
      is_standby: "{{ 'STANDBY' in ((_db_role | default('')) | upper) }}"

- name: "{{ current_sid }} - Display instance summary"
  ansible.builtin.debug:
    msg: |
      
      -------- {{ current_sid }} SECURITY CHECK --------
      Role: {{ _db_role | default('UNKNOWN') }} | Open Mode: {{ _db_open_mode | default('UNKNOWN') }}
      {{ (security_features_output | default({})).get('stdout', 'Unable to connect') }}
      Report: security_check_{{ current_sid }}_{{ _report_timestamp }}.txt
